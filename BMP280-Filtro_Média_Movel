#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BMP280.h>

Adafruit_BMP280 bmp;

#define TAMANHO_FILTRO 50

int32_t leiturasAltitude[TAMANHO_FILTRO];
int32_t leiturasTemperatura[TAMANHO_FILTRO];
int indice = 0;

void setup() {
  delay(10000);
  Serial.begin(115200);

  if (!bmp.begin(0x76)) {
    Serial.println("Não foi possível encontrar um sensor BMP280.");
    while (1);
  }
  bmp.setSampling(Adafruit_BMP280::MODE_NORMAL,     
                  Adafruit_BMP280::SAMPLING_X2,     
                  Adafruit_BMP280::SAMPLING_X16,    
                  Adafruit_BMP280::FILTER_X16,      
                  Adafruit_BMP280::STANDBY_MS_500); 
}

void loop() {
  leituraFiltroBMP280();

  Serial.print("Altitude (com filtro): ");
  Serial.print(leiturasAltitude[indice] / 100.0, 2); 
  Serial.println(" Metros");

  Serial.print("Temperatura (com filtro): ");
  Serial.print(leiturasTemperatura[indice] / 100.0, 2);
  Serial.println(" °C");

  indice = (indice + 1) % TAMANHO_FILTRO;

  delay(1000);
}

void leituraFiltroBMP280() {
  int32_t altitude = (int32_t)(bmp.readAltitude(1013.25) * 100); 
  int32_t temperatura = (int32_t)(bmp.readTemperature() * 100);
  leiturasAltitude[indice] = calcularMedia(altitude);
  leiturasTemperatura[indice] = calcularMedia(temperatura);
}

int32_t calcularMedia(int32_t novaLeitura) {
  static int32_t soma = 0;
  static int32_t buffer[TAMANHO_FILTRO];
  static int contador = 0;

  soma -= buffer[contador];
  buffer[contador] = novaLeitura;
  soma += novaLeitura;
  contador = (contador + 1) % TAMANHO_FILTRO;

  return soma / TAMANHO_FILTRO;
}
